<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registrar Miembro</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header>
        <img src="logo/logo Iglesia.png" alt="Logo Iglesia" class="logo">
        <h1>Control de Membresía</h1>
        <nav>
            <ul class="menu">
                <li><a href="index.html">Inicio</a></li>
                <li><a href="registrar.html">Registrar Miembro</a></li>
                <li><a href="miembros.html">Miembros</a></li>
                <li><a href="reportes.html">Reportes</a></li>
            </ul>
        </nav>
    </header>
    <main>
        <section>
            <h2>Registrar Miembro</h2>
            <div class="tabs">
                <button class="tab-btn" onclick="showForm('nino')">Niños</button>
                <button class="tab-btn" onclick="showForm('joven')">Jóvenes</button>
                <button class="tab-btn" onclick="showForm('adulto')">Adultos</button>
            </div>
            <div id="form-nino" class="formulario" style="display:block;">
                <h3>Registro de Niño</h3>
                <form>
                    <label>Iglesia:</label>
                    <select name="iglesia">
                        <option value="">Seleccione</option>
                        <option value="central">Iglesia Central</option>
                        <option value="tekera">Filial La Tekera</option>
                        <option value="pital">Filial El Pital</option>
                        <option value="sauce">Filial El Sauce</option>
                    </select><br>
                    <label>Nombre:</label><input type="text" name="nombre_nino"><br>
                    <label>Sexo:</label>
                    <select name="sexo_nino">
                        <option value="">Seleccione</option>
                        <option value="hombre">Hombre</option>
                        <option value="mujer">Mujer</option>
                    </select><br>
                    <label>Fecha de Nacimiento:</label><input type="date" name="fecha_nacimiento_nino" onchange="calcularEdad(this, 'edad_nino')"><br>
                    <label>Edad:</label><input type="number" name="edad_nino" id="edad_nino" min="0" max="12" readonly><br>
                    <label>Nombre del Padre:</label><input type="text" name="padre_nino"><br>
                    <label>Nombre de la Madre:</label><input type="text" name="madre_nino"><br>
                    <label>Fotografía:</label>
                    <div style="display:flex;gap:10px;align-items:center;">
                        <button type="button" onclick="abrirCamara(this)" style="padding:6px 12px;">Tomar foto</button>
                        <button type="button" onclick="cargarArchivo(this)" style="padding:6px 12px;">Cargar foto</button>
                        <input type="file" accept="image/*" name="foto" style="display:none;">
                        <img src="" alt="Vista previa" style="display:none;width:60px;height:60px;border-radius:50%;object-fit:cover;margin-left:10px;" class="preview-foto">
                    </div><br>
                    <button type="submit">Registrar Niño</button>
                </form>
            </div>
            <div id="form-joven" class="formulario" style="display:none;">
                <h3>Registro de Joven</h3>
                <form>
                    <label>Iglesia:</label>
                    <select name="iglesia">
                        <option value="">Seleccione</option>
                        <option value="central">Iglesia Central</option>
                        <option value="tekera">Filial La Tekera</option>
                        <option value="pital">Filial El Pital</option>
                        <option value="sauce">Filial El Sauce</option>
                    </select><br>
                    <label>Nombre:</label><input type="text" name="nombre_joven"><br>
                    <label>Sexo:</label>
                    <select name="sexo_joven">
                        <option value="">Seleccione</option>
                        <option value="hombre">Hombre</option>
                        <option value="mujer">Mujer</option>
                    </select><br>
                    <label>Fecha de Nacimiento:</label><input type="date" name="fecha_nacimiento_joven" onchange="calcularEdad(this, 'edad_joven')"><br>
                    <label>Edad:</label><input type="number" name="edad_joven" id="edad_joven" min="13" max="25" readonly><br>
                    <label>DUI (opcional):</label><input type="text" name="dui_joven" placeholder="00000000-0"><br>
                    <label>Teléfono:</label><input type="text" name="telefono_joven"><br>
                    <label>Nombre del Padre:</label><input type="text" name="padre_joven"><br>
                    <label>Nombre de la Madre:</label><input type="text" name="madre_joven"><br>
                    <label>Fotografía:</label>
                    <div style="display:flex;gap:10px;align-items:center;">
                        <button type="button" onclick="abrirCamara(this)" style="padding:6px 12px;">Tomar foto</button>
                        <button type="button" onclick="cargarArchivo(this)" style="padding:6px 12px;">Cargar foto</button>
                        <input type="file" accept="image/*" name="foto" style="display:none;">
                        <img src="" alt="Vista previa" style="display:none;width:60px;height:60px;border-radius:50%;object-fit:cover;margin-left:10px;" class="preview-foto">
                    </div><br>
                    <button type="submit">Registrar Joven</button>
                </form>
            </div>
            <div id="form-adulto" class="formulario" style="display:none;">
                <h3>Registro de Adulto</h3>
                <form>
                    <label>Iglesia:</label>
                    <select name="iglesia">
                        <option value="">Seleccione</option>
                        <option value="central">Iglesia Central</option>
                        <option value="tekera">Filial La Tekera</option>
                        <option value="pital">Filial El Pital</option>
                        <option value="sauce">Filial El Sauce</option>
                    </select><br>
                    <label>Nombre:</label><input type="text" name="nombre_adulto"><br>
                    <label>Sexo:</label>
                    <select name="sexo_adulto">
                        <option value="">Seleccione</option>
                        <option value="hombre">Hombre</option>
                        <option value="mujer">Mujer</option>
                    </select><br>
                    <label>Fecha de Nacimiento:</label><input type="date" name="fecha_nacimiento_adulto" onchange="calcularEdad(this, 'edad_adulto')"><br>
                    <label>Edad:</label><input type="number" name="edad_adulto" id="edad_adulto" min="26" readonly><br>
                    <label>DUI (opcional):</label><input type="text" name="dui_adulto" placeholder="00000000-0"><br>
                    <label>Estado Civil:</label>
                    <select name="estado_civil_adulto" id="estado_civil_adulto" onchange="mostrarConyugueOAcompanado()">
                        <option value="soltero">Soltero</option>
                        <option value="madre_soltera">Madre Soltera</option>
                        <option value="padre_soltero">Padre Soltero</option>
                        <option value="casado">Casado</option>
                        <option value="acompañado">Acompañado</option>
                        <option value="viudo">Viudo</option>
                    </select><br>
                    <div id="campo_conyugue" style="display:none;">
                        <label>Nombre del Cónyuge:</label><input type="text" name="nombre_conyugue"><br>
                    </div>
                    <div id="campo_acompanado" style="display:none;">
                        <label>Nombre del Acompañado(a):</label><input type="text" name="nombre_acompanado"><br>
                    </div>
                    <label>¿Tiene hijos?</label>
                    <select name="tiene_hijos" id="tiene_hijos" onchange="mostrarHijos()">
                        <option value="no">No</option>
                        <option value="si">Sí</option>
                    </select><br>
                    <div id="datos_hijos" style="display:none;">
                        <label>Cantidad de hijos:</label>
                        <input type="number" name="cantidad_hijos" id="cantidad_hijos" min="1" max="20" onchange="generarCamposHijos()"><br>
                        <div id="nombres_hijos"></div>
                    </div>
                    <label>Fotografía:</label>
                    <div style="display:flex;gap:10px;align-items:center;">
                        <button type="button" onclick="abrirCamara(this)" style="padding:6px 12px;">Tomar foto</button>
                        <button type="button" onclick="cargarArchivo(this)" style="padding:6px 12px;">Cargar foto</button>
                        <input type="file" accept="image/*" name="foto" style="display:none;">
                        <img src="" alt="Vista previa" style="display:none;width:60px;height:60px;border-radius:50%;object-fit:cover;margin-left:10px;" class="preview-foto">
                    </div><br>
                    <button type="submit">Registrar Adulto</button>
                </form>
            </div>
        </section>
    </main>
    <script>
        function showForm(tipo) {
            document.getElementById('form-nino').style.display = 'none';
            document.getElementById('form-joven').style.display = 'none';
            document.getElementById('form-adulto').style.display = 'none';
            document.getElementById('form-' + tipo).style.display = 'block';
        }
        function calcularEdad(input, idEdad) {
            const fechaNac = new Date(input.value);
            const hoy = new Date();
            let edad = hoy.getFullYear() - fechaNac.getFullYear();
            const m = hoy.getMonth() - fechaNac.getMonth();
            if (m < 0 || (m === 0 && hoy.getDate() < fechaNac.getDate())) {
                edad--;
            }
            document.getElementById(idEdad).value = edad > 0 ? edad : 0;
        }
        function mostrarConyugueOAcompanado() {
            var estado = document.getElementById('estado_civil_adulto').value;
            var campoConyugue = document.getElementById('campo_conyugue');
            var campoAcompanado = document.getElementById('campo_acompanado');
            if (estado === 'casado') {
                campoConyugue.style.display = 'block';
                campoAcompanado.style.display = 'none';
            } else if (estado === 'acompañado') {
                campoConyugue.style.display = 'none';
                campoAcompanado.style.display = 'block';
            } else {
                campoConyugue.style.display = 'none';
                campoAcompanado.style.display = 'none';
            }
        }
        function mostrarHijos() {
            var tieneHijos = document.getElementById('tiene_hijos').value;
            var datosHijos = document.getElementById('datos_hijos');
            var nombresHijos = document.getElementById('nombres_hijos');
            if (tieneHijos === 'si') {
                datosHijos.style.display = 'block';
            } else {
                datosHijos.style.display = 'none';
                nombresHijos.innerHTML = '';
            }
        }
        function generarCamposHijos() {
            var cantidad = parseInt(document.getElementById('cantidad_hijos').value) || 0;
            var nombresHijos = document.getElementById('nombres_hijos');
            nombresHijos.innerHTML = '';
            for (var i = 1; i <= cantidad; i++) {
                nombresHijos.innerHTML += '<label>Nombre del hijo ' + i + ':</label><input type="text" name="nombre_hijo_' + i + '"><br>';
            }
        }
        // === IndexedDB para miembros ===
const DB_NAME = 'membresiaDB';
const DB_VERSION = 1;
const STORE_NAME = 'miembros';

function abrirDB() {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        request.onupgradeneeded = function(e) {
            const db = e.target.result;
            if (!db.objectStoreNames.contains(STORE_NAME)) {
                db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
            }
        };
        request.onsuccess = function(e) { resolve(e.target.result); };
        request.onerror = function(e) { reject(e.target.error); };
    });
}
async function agregarMiembroIndexedDB(miembro) {
    const db = await abrirDB();
    return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE_NAME, 'readwrite');
        tx.objectStore(STORE_NAME).add(miembro).onsuccess = resolve;
        tx.onerror = e => reject(e.target.error);
    });
}
async function obtenerMiembrosIndexedDB() {
    const db = await abrirDB();
    return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE_NAME, 'readonly');
        const store = tx.objectStore(STORE_NAME);
        const req = store.getAll();
        req.onsuccess = () => resolve(req.result);
        req.onerror = e => reject(e.target.error);
    });
}
async function editarMiembroIndexedDB(id, datos) {
    const db = await abrirDB();
    return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE_NAME, 'readwrite');
        const store = tx.objectStore(STORE_NAME);
        const req = store.get(id);
        req.onsuccess = () => {
            const miembro = req.result;
            if (!miembro) return reject('No encontrado');
            Object.assign(miembro, datos);
            store.put(miembro).onsuccess = resolve;
        };
        req.onerror = e => reject(e.target.error);
    });
}
async function eliminarMiembroIndexedDB(id) {
    const db = await abrirDB();
    return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE_NAME, 'readwrite');
        tx.objectStore(STORE_NAME).delete(id).onsuccess = resolve;
        tx.onerror = e => reject(e.target.error);
    });
}
// Migrar de localStorage a IndexedDB solo la primera vez
(async function migrarLocalStorage() {
    if (!localStorage.getItem('migrado_indexeddb')) {
        const miembros = JSON.parse(localStorage.getItem('miembros') || '[]');
        for (const m of miembros) {
            await agregarMiembroIndexedDB(m);
        }
        localStorage.setItem('migrado_indexeddb', '1');
        // Opcional: limpiar localStorage
        // localStorage.removeItem('miembros');
    }
})();
// Reemplazar funciones para usar IndexedDB
async function obtenerMiembros() {
    return await obtenerMiembrosIndexedDB();
}
async function agregarMiembro(miembro) {
    await agregarMiembroIndexedDB(miembro);
}
        // Adaptar guardarRegistro para usar await
async function guardarRegistro(form, datos, editar, idx) {
    Array.from(form.elements).forEach(el => {
        if (el.name && el.type !== 'submit' && el.type !== 'file') datos[el.name] = el.value;
    });
    if (form.parentElement.id === 'form-nino') datos.tipo = 'nino';
    if (form.parentElement.id === 'form-joven') datos.tipo = 'joven';
    if (form.parentElement.id === 'form-adulto') datos.tipo = 'adulto';
    if (editar && idx !== null) {
        await editarMiembroIndexedDB(Number(idx), datos);
        mostrarMensaje('¡Cambios guardados exitosamente!');
        localStorage.removeItem('editar_miembro_idx');
        window.location.href = 'miembros.html';
    } else {
        await agregarMiembroIndexedDB(datos);
        mostrarMensaje('¡Registro exitoso!');
        form.reset();
        const preview = form.querySelector('.preview-foto');
        if (preview) {
            preview.src = '';
            preview.style.display = 'none';
        }
    }
}
        // Manejar el registro y edición de los tres formularios
        window.addEventListener('DOMContentLoaded', function() {
            const formularios = document.querySelectorAll('.formulario form');
            formularios.forEach(form => {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const datos = {};
                    const params = new URLSearchParams(window.location.search);
                    const editar = params.get('editar');
                    const idx = localStorage.getItem('editar_miembro_idx');
                    // Procesar foto (si hay)
                    const fotoInput = form.querySelector('input[type="file"][name="foto"]');
                    if (fotoInput && fotoInput.files && fotoInput.files[0]) {
                        const reader = new FileReader();
                        reader.onload = function(ev) {
                            datos.foto_base64 = ev.target.result;
                            guardarRegistro(form, datos, editar, idx);
                        };
                        reader.readAsDataURL(fotoInput.files[0]);
                    } else {
                        guardarRegistro(form, datos, editar, idx);
                    }
                });
            });
            // Cargar datos para edición si corresponde
            const params = new URLSearchParams(window.location.search);
            const editar = params.get('editar');
            const idx = localStorage.getItem('editar_miembro_idx');
            if (editar && idx !== null) {
                const miembros = obtenerMiembros();
                const miembro = miembros[parseInt(idx)];
                if (miembro) {
                    let tipo = miembro.tipo || (miembro.nombre_nino ? 'nino' : miembro.nombre_joven ? 'joven' : 'adulto');
                    showForm(tipo);
                    let form = document.querySelector(`#form-${tipo} form`);
                    for (let key in miembro) {
                        let input = form.querySelector(`[name='${key}']`);
                        if (input) {
                            if (input.type === 'file') continue;
                            input.value = miembro[key];
                        }
                    }
                    // Cargar hijos si es adulto
                    if (tipo === 'adulto' && miembro.tiene_hijos === 'si') {
                        mostrarHijos();
                        setTimeout(() => {
                            document.getElementById('cantidad_hijos').value = miembro.cantidad_hijos;
                            generarCamposHijos();
                            for (let i = 1; i <= miembro.cantidad_hijos; i++) {
                                let hijo = form.querySelector(`[name='nombre_hijo_${i}']`);
                                if (hijo) hijo.value = miembro['nombre_hijo_' + i];
                            }
                        }, 100);
                    }
                }
            }
        });
        // Cambiar el botón de submit por button y manejar el guardado manualmente
        // (Esto es para máxima compatibilidad móvil, especialmente en iOS/Safari)
        document.querySelectorAll('.formulario form').forEach(form => {
            // Cambia el botón de submit a type="button" y agrega id único
            const btn = form.querySelector('button[type="submit"]');
            if (btn) {
                btn.type = 'button';
                btn.classList.add('btn-guardar');
            }
        });
        // Ahora asignar el evento click a los botones de guardar
        window.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.formulario form .btn-guardar').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    const form = btn.closest('form');
                    const datos = {};
                    const params = new URLSearchParams(window.location.search);
                    const editar = params.get('editar');
                    const idx = localStorage.getItem('editar_miembro_idx');
                    // Procesar foto (si hay)
                    const fotoInput = form.querySelector('input[type="file"][name="foto"]');
                    if (fotoInput && fotoInput.files && fotoInput.files[0]) {
                        const reader = new FileReader();
                        reader.onload = function(ev) {
                            datos.foto_base64 = ev.target.result;
                            try { guardarRegistro(form, datos, editar, idx); } catch(err) { mostrarMensaje('Error: ' + err.message); }
                        };
                        reader.readAsDataURL(fotoInput.files[0]);
                    } else {
                        try { guardarRegistro(form, datos, editar, idx); } catch(err) { mostrarMensaje('Error: ' + err.message); }
                    }
                });
            });
        });
        function abrirCamara(btn) {
            const input = btn.parentElement.querySelector('input[type="file"]');
            input.accept = 'image/*';
            input.capture = 'environment';
            input.click();
        }
        function cargarArchivo(btn) {
            const input = btn.parentElement.querySelector('input[type="file"]');
            input.accept = 'image/*';
            input.removeAttribute('capture');
            input.click();
        }
        document.querySelectorAll('input[type="file"][name="foto"]').forEach(input => {
            input.addEventListener('change', function() {
                const preview = input.parentElement.querySelector('.preview-foto');
                if (input.files && input.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        preview.src = e.target.result;
                        preview.style.display = 'inline-block';
                    };
                    reader.readAsDataURL(input.files[0]);
                } else {
                    preview.src = '';
                    preview.style.display = 'none';
                }
            });
        });
    </script>
    <footer>
        <p>&copy; 2025 Iglesia. Todos los derechos reservados.</p>
    </footer>
</body>
</html>
